---
title: "C_malloc实现"
date: 2023-03-14
categories: [c_c++]
tags: [c_c++]
excerpt: "malloc实现"
---

# malloc实现

```c
#include<stdio.h>
#include<malloc.h>
int main(void) {
    int *p = (int *)malloc(sizeof(int));
    free(p);
    p = NULL;
    return 0;
}
```

malloc其采用内存池方式, 以减少内存碎片和系统调用开销

malloc采用隐式链表结构将堆区分成连续、大小不一的块, 包含已分配块和未分配块, 以块作为内存管理基本单位

malloc采用显示链表结构来管理所有空闲块, 使用一个双向链表将空闲块连接起来, 每一个空闲块记录了一个连续、未分配地址

## 使用

### 申请

- 空闲链表

空闲存储空间以空闲链表方式组织(地址递增), 每个块包含一个长度、一个指向下一块指针以及一个指向自身存储空间指针

申请请求时, malloc会扫描空闲链表, 直到找到一个足够大块为止(首次适应), 因此每次调用malloc时耗时均不同

#### 查找算法

- 首次适配

第一次找到足够大内存块就分配, 会产生很多内存碎片

- 下一次适配

等第二次找到足够大内存块就分配,会产生比较少内存碎片

- 最佳适配

对堆进行彻底搜索, 从头开始遍历所有块, 使用块容量大于目标容量且差值最小的块被选择

#### 查找内存块存在

- 若与请求大小相符

将其从链表中移走并返回

- 若该块太大

将内存块分为两部分, 尾部部分返回用户, 剩下部分留在空闲链表中(更改头部信息), 因此malloc是分配一块连续内存

#### 查找内存块不存在

- 若申请空间小于128k

调用$brk()$, 通过移动堆区末尾地址指针$\_enddata$, 申请空间

- 若申请空间大于128k

$mmap()$ 系统调用函数来在虚拟地址空间中(堆和栈中间, 称为"文件映射区域")找一块空间来开辟

#### mmap功能

- 映射磁盘文件到内存中

- 匿名映射, 不映射磁盘文件, 而向映射区申请一块内存

### 释放

释放时, 首先搜索空闲链表, 找到可插入被释放块的合适位置

若与被释放块相邻任一边是一个空闲块, 则将这两个块合为一个更大块, 以减少内存碎片

## 管理

$brk$、$sbrk$、$mmap$都属于系统调用, 若每次申请内存都调用这三个, 会产生系统调用影响性能

其次, 这样申请内存容易产生碎片, 因为堆是从低地址到高地址, 若高地址内存没有被释放, 低地址内存就不能被回收

所以malloc采用内存池管理方式(ptmalloc)

Ptmalloc 采用边界标记法将内存划分成很多块, 从而对内存分配与回收进行管理

为了内存分配函数malloc高效性, ptmalloc会预先向操作系统申请一块内存供用户使用, 当申请和释放内存时, ptmalloc会将这些内存管理起来, 并通过一些策略来判断是否将其回收给操作系统 

这样最大好处是使用户申请和释放内存时候更加高效, 避免产生过多内存碎片
