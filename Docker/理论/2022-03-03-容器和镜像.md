---
title: "Docker-容器和镜像"
date: 2022-03-03
categories: [Docker]
tags: [Docker]
excerpt: "容器和镜像"
---

# 镜像与容器

## 镜像

## 镜像层 Image Layer

镜像可看成是由多个镜像层叠加起来的一个文件系统(通过UnionFS与AUFS文件联合系统实现)

也可以简单理解为一个基本的镜像, 每个镜像层之间通过指针的形式进行叠加

```mermaid
graph LR;
    S(镜像层组成)

    S-->A(镜像层 ID)
    S-->B(镜像层指针, 指向父层)
    S-->C(元数据Layer Metadata)
        C-->C1(构建和运行信息)
        C-->C2(父层信息)
```

只读层和读写层「Top Layer」的组成部分基本一致, 同时读写层可通过docker commit转换成只读层

元数据(metadata)就是关于这个层的额外信息, 它不仅能够让Docker获取运行和构建时的信息, 还包括父层的层次信息

需要注意, 只读层和读写层都包含元数据

每一层都包括了一个指向父层的指针. 如果一个层没有这个指针, 说明它处于最底层

一个容器的元数据好像是被分成了很多文件, 但或多或少能够在/var/lib/docker/containers/目录下找到, 就是一个可读层的id

这个目录下的文件大多是运行时的数据, 比如说网络, 日志等等

## 镜像 Image

镜像是只读层的集合

镜像包含多个只读层, 它们重叠在一起, 除了最下面一层, 其它层都会有一个指针指向下一层

这些层是Docker内部的实现细节, 并且能够在docker主机的文件系统上访问到

统一文件系统(union file system, 升级版为AUFS)技术能够将不同的层整合成一个文件系统, 为这些层提供了一个统一的视角

这样就隐藏了多层的存在, 在用户的角度看来, 只存在一个文件系统

你可以在你的主机文件系统上找到有关这些层的文件. 需要注意的是, 在一个运行中的容器内部, 这些层是不可见的

Image存在于/var/lib/docker/aufs目录下

## 容器

### Container

容器是一层读写层+多层只读层

容器(container)的定义和镜像(image)几乎一模一样, 也是一堆层的统一视角, 唯一区别在于容器的最上面那一层是可读可写的

容器 = 镜像 + 读写层, 并且容器的定义并没有提及是否要运行容器

### Running Container

运行态容器为一层读写层+多层只读层+隔离的进程空间和包含其中的进程

运行状态的容器「Running Container」是由一个可读写的文件系统「静态容器」+ 隔离的进程空间和其中的进程构成的

正是文件系统隔离技术使得Docker成为了一个前途无量的技术. 一个容器中的进程可能会对文件进行修改、删除、创建, 这些改变都将作用于可读写层(read-write layer)

```sh
# 即便是这个ubuntu容器不再运行, 我们依旧能够在主机的文件系统上找到这个新文件
docker run ubuntu touch happiness.txt
　　
find / -name happiness.txt

/var/lib/docker/aufs/diff/860a7b...889/happiness.txt
```

通过上述内容, 我们已经详细介绍了镜像与容器的区别, 镜像由一层层只读层堆在一起, 容器为镜像只读层+读写层

运行态容器为由一个可读写的文件系统「静态容器」+ 隔离的进程空间和其中的进程构成
