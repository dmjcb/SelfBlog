---
title: "C/C++目标文件"
date: 2022-10-02
categories: [C&C++]
tags: [C&C++]
excerpt: "目标文件"
---

# 目标文件

经过编译器预处理、编译、汇编过程所生成的能被CPU直接识别的二进制文件称为目标文件($Object$ $File$)

从文件结构上来讲, 目标文件与可执行文件的组织形式非常类似, 只是有些变量和函数的地址还未确定, 导致不能执行

## 结构

目标文件将编译后的机器指令代码、数据、符号表、调试信息、字符串等以 $Section$ 形式存储

目标文件在 $x86-64$ $Linux$ 和 $Unix$ 系统中使用可执行可链接格式即 (ELF), 典型的 elf 可重定位目标文件格式如下

![](https://raw.githubusercontent.com/dmjcb/SelfImgur/main/2022-10-04-23-10.svg)

段名大都以`.`作为前缀, 表示系统保留

| 段  名              | 说  明                                                                                                |
| ------------------- | ---------------------------------------------------------------------------------------------------- |
| ELF Header          | 文件头, 描述整个目标文件属性, 包括是否可执行、属于动态/静态链接、入口地址值、目标硬件/操作系统、段表偏移等信息 |
| .text               | 代码段, 存放编译后的机器指令, 即各个函数的二进制代码                                                      |
| .data               | 数据段, 存放全局变量和静态变量                                                                          |
| .rodata             | 只读数据段, 存放一般的常量、字符串常量等                                                                 |
| .rel.text .rel.data | 重定位段, 包含了目标文件中需要重定位的全局符号以及重定位入口                                               |
| .comment            | 注释信息段, 存放的是编译器的版本信息, 比如"GCC:(GUN) 4.2.0"                                              |
| .debug              | 调试信息                                                                                              |
| .line               | 调试时的行号表, 即源代码行号与编译后指令的对应表                                                          |  
| Section Table       | Section表, 描述 ELF 文件包含的所有Section信息, 如Section名、长度、在文件中偏移、读写权限以及其他属性        |
| .strtab             | 字符串表, 保存了 ELF 文件用到的字符串, 比如变量名、函数名、段名等                                          |
| .symtab             | 符号表, 保存了全局变量名、局部变量名、函数名等在字符串表中的偏移                                           |

ELF 文件的Section结构是由段表来决定的, 编译器、链接器和装载器都是依靠Section表来定位和访问各个Section

因为字符串长度往往不定, 所以用固定的结构来表示比较困难, 常见的做法就是把字符串集中起来存放到字符串表中, 然后使用字符串在表中的偏移来引用字符串

除了这些系统保留的段名, 应用程序也可以使用其它名字定义自己的Section, 应用程序自定义的的Section不建议使用.作为前缀, 否则容易和系统保留段发生冲突

## 分类

### 可执行文件 (Executable File)

包含可以直接执行的程序

例如 Linux下的a.out, Windows下的.exe

现在PC平台上流行的可执行文件格式均为COFF格式的变种

$Windows$ 下为 $PE$ ($Portable$ $Executable$)

$Linux$ 下为 $ELF$ ($Executable$ $Linkable$ $Format$)

### 可重定位文件 (Relocatable File)

包含代码和数据, 可被用来链接成可执行文件或者共享目标文件

例如静态链接库, Linux下的`.o`/`.a`, Windows下的`.obj` 和 `.lib`

### 共享目标文件 (Shared Object File)

包含了代码和数据, 可在以下两种情况使用

- 链接器可用这种文件跟其他的可重定位文件链接, 产生新的目标文件

- 动态链接器可以将将共享目标文件和其他可执行文件结合, 作为进程的一部分运行

例如, linxu下的`.so` 以及Windows下的`.dll`

### 核心转储文件 (Core Dump File)

当进程意外终止时, 系统用来存储该进程的地址空间的内容以及其他信息

例如, Linux 下的 core dump
